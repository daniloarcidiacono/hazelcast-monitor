version: 2
jobs:
  build_prepare:
    docker:
      - image: daniloarcidiacono/ci-java-node:0.4.0

    working_directory: ~/hazelcast-monitor

    steps:
      - checkout

      - persist_to_workspace:
          root: '~'
          paths:
            - hazelcast-monitor

  build_fe:
    docker:
      - image: daniloarcidiacono/ci-java-node:0.4.0

    working_directory: ~/hazelcast-monitor

    steps:
      - attach_workspace:
          at: '~'

      - restore_cache:
          key: npm-dependency-cache-{{ checksum "hazelcast-monitor-webapp/package.json" }}

      - run:
          name: Install npm packages
          command: cd hazelcast-monitor-webapp && npm install

      - save_cache:
          key: npm-dependency-cache-{{ checksum "hazelcast-monitor-webapp/package.json" }}
          paths:
            - hazelcast-monitor-webapp/node_modules

      - run:
          name: Build prod
          command: cd hazelcast-monitor-webapp && npm run build-prod

      - run:
          name: Zipping
          command: cd hazelcast-monitor-webapp/dist && zip -r hazelcast-monitor-$CIRCLE_TAG.zip hazelcast-monitor

      - run:
          name: Create artifacts directory
          command: mkdir ./artifacts && cp hazelcast-monitor-webapp/dist/hazelcast-monitor-*.zip ./artifacts

      - store_artifacts:
          path: artifacts
          destination: artifacts-fe

      - persist_to_workspace:
          root: '~'
          paths:
            - hazelcast-monitor/hazelcast-monitor-webapp/dist/hazelcast-monitor-*.zip

  build_be:
    docker:
      - image: daniloarcidiacono/ci-java-node:0.4.0

    working_directory: ~/hazelcast-monitor

    steps:
      - attach_workspace:
          at: '~'

      - restore_cache:
          key: hazelcast-monitor-{{ checksum "pom.xml" }}

      - run:
          command: mvn verify dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: hazelcast-monitor-{{ checksum "pom.xml" }}

      - run:
          command: mvn clean package -Pdocs

      - run:
          name: Create artifacts directory
          command: |
            shopt -s globstar
            mkdir ./artifacts
            cp **/target/*.jar ./artifacts

      - store_artifacts:
          path: artifacts
          destination: artifacts-be

      - persist_to_workspace:
          root: '~'
          paths:
            - hazelcast-monitor/**/target/*-javadoc.jar

  deploy_github:
    docker:
      - image: daniloarcidiacono/ci-java-node:0.4.0

    working_directory: ~/hazelcast-monitor

    steps:
      - attach_workspace:
          at: '~'

      - deploy:
          name: Create GitHub release
          command: |
            shopt -s globstar
            hub release create -d \
                               -a **/target/*-javadoc.jar \
                               -a hazelcast-monitor-webapp/dist/hazelcast-monitor-*.zip \
                               -F CHANGELOG_LATEST.md $CIRCLE_TAG

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_prepare:
          filters:
            tags:
              only: /^pre.*/
            branches:
              ignore: /.*/

      - build_fe:
          requires:
            - build_prepare
          filters:
            tags:
              only: /^pre.*/
            branches:
              ignore: /.*/

      - build_be:
          requires:
            - build_prepare
          filters:
            tags:
              only: /^pre.*/
            branches:
              ignore: /.*/

      - deploy_github:
          requires:
            - build_fe
            - build_be
          filters:
            tags:
              only: /^pre.*/
            branches:
              ignore: /.*/
